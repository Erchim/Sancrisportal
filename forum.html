<!doctype html>
<html lang="en">
<head>
  <title>Forum â€” Events San Cristobal</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#1b0f0a" />
  <link rel="stylesheet" href="assets/style.css?v=25.0" />
  <meta name="description" content="Community forum about San CristÃ³bal de las Casas: questions, tips, locals, creators." />
</head>
<body>
  <header class="site-header">
    <div class="wrap header-inner">
      <a class="brand" href="index.html" aria-label="Home">
        <span class="brand-title" data-site-title>Events San Cristobal</span>
        <span class="brand-sub" data-site-sub>Local portal for San CristÃ³bal de las Casas: events, life guides, nature trips, hotels, food, and practical FAQ.</span>
      </a>
      <div class="header-actions">
        <button class="icon-btn" id="searchBtn" aria-label="Search" aria-expanded="false" aria-controls="searchPanel">ðŸ”Ž</button>
        <button class="icon-btn" id="menuBtn" aria-label="Menu" aria-expanded="false" aria-controls="siteNav">â˜°</button>
      </div>
    </div>
    <div class="wrap">
      <div class="search-panel" id="searchPanel" hidden>
        <form class="search-form" action="search.html" method="get">
          <input class="search-input" id="headerSearchInput" type="search" name="q" placeholder="Search the portalâ€¦" autocomplete="off" />
          <button class="btn" type="submit">Search</button>
        </form>
        <div class="suggestions" id="headerSuggestions" hidden></div>
      </div>

      <nav class="nav" id="siteNav" hidden>
        <a href="index.html">Home</a>
        <a href="articles.html">Life</a>
        <a href="nature.html">Nature</a>
        <a href="events.html">Events</a>
        <a href="hotels.html">Hotels</a>
        <a href="restaurants.html">Food</a>
        <a href="music.html">Music</a>
        <a href="faq.html">FAQ</a>
        <a href="submit.html">Submit</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section class="hero hero-simple">
      <h1 class="h1">Forum</h1>
      <p class="lead">Ask questions, share tips, and help others discover San Cris.</p>
      <div class="hero-actions">
        <a class="btn" href="submit-thread.html">Start a topic</a>
        <a class="btn ghost" href="community.html">Community posts</a>
      </div>
      <div id="forumNotice" style="margin-top:10px;"></div>
    </section>

    <section class="section">
      <div class="grid2">
        <div class="card" style="padding:16px;">
          <h2 style="margin:0 0 10px 0;">Categories</h2>
          <div id="cats" class="stack"></div>
        </div>
        <div class="card" style="padding:16px;">
          <h2 style="margin:0 0 10px 0;">Latest topics</h2>
          <div id="latest" class="stack"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="wrap footer-inner">
      <div>Â© <span id="year"></span> <span data-site-title>Portal</span></div>
      <div class="muted">Built for travelers & locals</div>
    </div>
  </footer>

  <script src="assets/app.js?v=25.0"></script>
  <script type="module" src="assets/auth-nav.mjs?v=25.0"></script>
  <script type="module">
    import {
      isConfigured,
      listForumCategories,
      listRecentForumThreads,
      escapeHtml,
      getMyProfile
    } from "./assets/community.mjs?v=25.0";

    const notice = document.getElementById('forumNotice');
    const catsEl = document.getElementById('cats');
    const latestEl = document.getElementById('latest');

    const row = ({title, subtitle, href}) => `
      <div class="row">
        <div>
          <div class="row-title"><a class="link" href="${href}">${title}</a></div>
          <div class="muted small">${subtitle||''}</div>
        </div>
      </div>
    `;

    function setNotice(html){ notice.innerHTML = html || '' }

    async function load(){
      if(!isConfigured()){
        setNotice(`<div class="notice"><div class="notice-title">Connect Supabase</div><div class="notice-body">Forum is ready, but you need to set <span class="kbd">assets/supabase-config.js</span> and run the SQL.</div></div>`);
        catsEl.innerHTML = `<div class="muted small">Not connected yet.</div>`;
        latestEl.innerHTML = `<div class="muted small">Not connected yet.</div>`;
        return;
      }

      const prof = await getMyProfile().catch(()=>null);
      if(prof && prof.status !== 'active'){
        setNotice(`<div class="notice"><div class="notice-title">Account pending</div><div class="notice-body">You can read the forum, but posting requires approval.</div></div>`);
      } else {
        setNotice('');
      }

      const cats = await listForumCategories();
      catsEl.innerHTML = cats.length ? cats.map(c=>row({
        title: escapeHtml(c.title),
        subtitle: escapeHtml(c.description || ''),
        href: `forum-category.html?slug=${encodeURIComponent(c.slug)}`
      })).join('') : `<div class="muted small">No categories yet.</div>`;

      const latest = await listRecentForumThreads({ limit: 10 });
      latestEl.innerHTML = latest.length ? latest.map(t=>row({
        title: escapeHtml(t.title),
        subtitle: `${escapeHtml(t.forum_categories?.title || '')} â€¢ ${escapeHtml(t.profiles?.display_name || 'Unknown')} â€¢ ${new Date(t.created_at).toLocaleDateString()}`,
        href: `forum-thread.html?id=${encodeURIComponent(t.id)}`
      })).join('') : `<div class="muted small">No topics yet. Start the first one.</div>`;
    }

    load();
  </script>
</body>
</html>
