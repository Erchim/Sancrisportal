<!doctype html>
<html lang="en">
<head>
  <title>Businesses â€” Events San Cristobal</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#1b0f0a" />
  <link rel="stylesheet" href="assets/style.css?v=25.0" />
  <meta name="description" content="Hotels, cafÃ©s, restaurants, tours, studios and other local businesses." />
</head>
<body>
  <header class="site-header">
    <div class="wrap header-inner">
      <a class="brand" href="index.html" aria-label="Home">
        <span class="brand-title" data-site-title>Events San Cristobal</span>
        <span class="brand-sub" data-site-sub>Local portal for San CristÃ³bal de las Casas: events, life guides, nature trips, hotels, food, and practical FAQ.</span>
      </a>
      <div class="header-actions">
        <button class="icon-btn" id="searchBtn" aria-label="Search" aria-expanded="false" aria-controls="searchPanel">ðŸ”Ž</button>
        <button class="icon-btn" id="menuBtn" aria-label="Menu" aria-expanded="false" aria-controls="siteNav">â˜°</button>
      </div>
    </div>
    <div class="wrap">
      <div class="search-panel" id="searchPanel" hidden>
        <form class="search-form" action="search.html" method="get">
          <input class="search-input" id="headerSearchInput" type="search" name="q" placeholder="Search the portalâ€¦" autocomplete="off" />
          <button class="btn" type="submit">Search</button>
        </form>
        <div class="suggestions" id="headerSuggestions" hidden></div>
      </div>

      <nav class="nav" id="siteNav" hidden>
        <a href="index.html">Home</a>
        <a href="articles.html">Life</a>
        <a href="nature.html">Nature</a>
        <a href="events.html">Events</a>
        <a href="hotels.html">Hotels</a>
        <a href="restaurants.html">Food</a>
        <a href="music.html">Music</a>
        <a href="faq.html">FAQ</a>
        <a href="community.html">Community</a>
        <a href="forum.html">Forum</a>
        <a href="businesses.html" aria-current="page">Businesses</a>
        <a href="submit.html">Submit</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section class="hero hero-simple">
      <h1 class="h1">Local businesses</h1>
      <p class="lead">Discover places run by locals, expats, artists, and creators. Want to add your project? Submit a profile.</p>
      <div class="hero-actions">
        <a class="btn" href="submit-business.html">Submit business</a>
      </div>
    </section>

    <section class="section">
      <div class="card" style="padding:14px;">
        <div class="filters" style="margin:0;">
          <input id="q" class="search-input" type="search" placeholder="Search by name or descriptionâ€¦" style="flex:1;" />
          <select id="cat" class="select" style="max-width:220px;">
            <option value="">All categories</option>
            <option value="cafe">Cafe</option>
            <option value="restaurant">Restaurant</option>
            <option value="hotel">Hotel/Hostel</option>
            <option value="tour">Tours</option>
            <option value="studio">Studio / Art</option>
            <option value="music">Music / Venue</option>
            <option value="other">Other</option>
          </select>

<select id="sort" class="select" style="max-width:190px;">
  <option value="newest">Newest</option>
  <option value="top">Top rated</option>
  <option value="az">Aâ€“Z</option>
</select>
          <button id="go" class="btn">Search</button>
        </div>
        <div id="notice" class="muted" style="margin-top:10px;"></div>
      </div>

      <div id="grid" class="cards" style="margin-top:14px;"></div>
    </section>
  </main>

  <footer class="footer">
    <div class="wrap footer-inner">
      <div>Â© <span id="year"></span> <span data-site-title>Portal</span></div>
      <div class="muted">Built for travelers & locals</div>
    </div>
  </footer>

  <script src="assets/app.js?v=25.0"></script>
  <script type="module" src="assets/auth-nav.mjs?v=25.0"></script>
  <script type="module">
    import { isConfigured, listBusinesses } from "./assets/community.mjs?v=25.0";

    const grid = document.getElementById('grid');
    const notice = document.getElementById('notice');
    const q = document.getElementById('q');
    const cat = document.getElementById('cat');
    const sort = document.getElementById('sort');
    const go = document.getElementById('go');

    function cardHTML(b) {
      const cover = b.cover_url ? `style="background-image:url('${b.cover_url}');"` : '';
      const catLabel = (b.category || 'other').toUpperCase();
      return `
        <a class="card" href="business.html?id=${encodeURIComponent(b.id)}" style="overflow:hidden; text-decoration:none;">
          <div class="card-cover" ${cover}></div>
          <div class="card-body">
            <div class="card-meta"><span class="pill">${catLabel}</span>${b.avg_rating ? `<span class="pill" style="margin-left:8px;">â˜… ${Number(b.avg_rating).toFixed(1)}${b.rating_count ? ` (${b.rating_count})` : ""}</span>` : ``}</div>
            <h3 class="card-title" style="margin-top:8px;">${escapeHtml(b.name || '')}</h3>
            <p class="muted" style="margin:8px 0 0 0;">Open profile â†’</p>
          </div>
        </a>
      `;
    }

    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, (c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    }

    async function run() {
      if (!isConfigured()) {
        notice.textContent = 'Supabase is not configured yet. Set SUPABASE_URL and SUPABASE_ANON_KEY in assets/supabase-config.js.';
        return;
      }
      notice.textContent = 'Loadingâ€¦';
      const items = await listBusinesses({ q: q.value.trim() || null, category: cat.value || null, sort: sort?.value || 'newest', limit: 60 });
      if (!items.length) {
        notice.textContent = 'No businesses found yet. You can be the first to submit one.';
        grid.innerHTML = '';
        return;
      }
      notice.textContent = `Showing ${items.length} profiles`;
      grid.innerHTML = items.map(cardHTML).join('');
    }

    go.addEventListener('click', (e)=>{ e.preventDefault(); run(); });
    q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); run(); } });
    cat.addEventListener('change', ()=>run());
    sort?.addEventListener('change', ()=>run());

    run();
  </script>
</body>
</html>
