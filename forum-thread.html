<!doctype html>
<html lang="en">
<head>
  <title>Topic â€” Events San Cristobal</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#1b0f0a" />
  <link rel="stylesheet" href="assets/style.css?v=25.0" />
  <meta name="description" content="Forum topic." />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <header class="site-header">
    <div class="wrap header-inner">
      <a class="brand" href="index.html" aria-label="Home">
        <span class="brand-title" data-site-title>Events San Cristobal</span>
        <span class="brand-sub" data-site-sub>Local portal for San CristÃ³bal de las Casas: events, life guides, nature trips, hotels, food, and practical FAQ.</span>
      </a>
      <div class="header-actions">
        <button class="icon-btn" id="searchBtn" aria-label="Search" aria-expanded="false" aria-controls="searchPanel">ðŸ”Ž</button>
        <button class="icon-btn" id="menuBtn" aria-label="Menu" aria-expanded="false" aria-controls="siteNav">â˜°</button>
      </div>
    </div>
    <div class="wrap">
      <div class="search-panel" id="searchPanel" hidden>
        <form class="search-form" action="search.html" method="get">
          <input class="search-input" id="headerSearchInput" type="search" name="q" placeholder="Search the portalâ€¦" autocomplete="off" />
          <button class="btn" type="submit">Search</button>
        </form>
        <div class="suggestions" id="headerSuggestions" hidden></div>
      </div>

      <nav class="nav" id="siteNav" hidden>
        <a href="index.html">Home</a>
        <a href="articles.html">Life</a>
        <a href="nature.html">Nature</a>
        <a href="events.html">Events</a>
        <a href="hotels.html">Hotels</a>
        <a href="restaurants.html">Food</a>
        <a href="music.html">Music</a>
        <a href="faq.html">FAQ</a>
        <a href="community.html">Community</a>
        <a href="forum.html">Forum</a>
        <a href="businesses.html">Businesses</a>
        <a href="submit.html">Submit</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section class="hero hero-simple">
      <h1 class="h1" id="title">Topic</h1>
      <p class="lead" id="meta"></p>
      <div class="hero-actions">
        <a class="btn ghost" href="forum.html">Forum</a>
        <a class="btn" id="backToCat" href="forum.html">Category</a>
      </div>
    </section>

    <section class="section">
      <article class="card" style="padding:18px;">
        <div id="body" class="prose"></div>
      </article>

      <div style="height:14px"></div>

      <div class="card" style="padding:18px;">
        <h2 style="margin:0 0 12px 0;">Replies</h2>
        <div id="replies" class="stack"></div>

        <div style="height:14px"></div>

        <div class="card" style="padding:14px; background:rgba(255,255,255,0.03);">
          <div class="muted small" id="replyHint">Sign in to reply.</div>
          <textarea id="replyBody" class="input" rows="4" placeholder="Write a replyâ€¦" style="margin-top:10px;"></textarea>
          <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn" id="replySend">Send</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="wrap footer-inner">
      <div>Â© <span id="year"></span> <span data-site-title>Portal</span></div>
      <div class="muted">Built for travelers & locals</div>
    </div>
  </footer>

  <script src="assets/app.js?v=25.0"></script>
  <script type="module" src="assets/auth-nav.mjs?v=25.0"></script>
  <script type="module">
    import { isConfigured, getUser, getMyProfile, makeContentRef, submitReport, openReportModal, getForumThread, listForumReplies, submitForumReply } from "./assets/community.mjs?v=25.0";

    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    const titleEl = document.getElementById('title');
    const metaEl = document.getElementById('meta');
    const bodyEl = document.getElementById('body');
    const repliesEl = document.getElementById('replies');
    const backToCat = document.getElementById('backToCat');

    const replyHint = document.getElementById('replyHint');
    const replyBody = document.getElementById('replyBody');
    const replySend = document.getElementById('replySend');

    const esc = (s)=>String(s??'').replace(/[&<>'"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
    let canReport = false;

    function renderMd(md){
      if (window.marked) return window.marked.parse(md||'');
      return `<pre>${esc(md||'')}</pre>`;
    }

    function replyRow(r){
      const who = r?.profiles?.display_name || 'Member';
      const when = r?.created_at ? new Date(r.created_at).toLocaleString() : '';
      return `
        <div class="row">
          <div>
            <div class="row-title">${esc(who)}</div>
            <div class="muted small">${esc(when)}${canReport ? ` â€¢ <button class="link-btn" type="button" data-report-ref="forum_reply:${r.id}">Report</button>` : ``}</div>
            <div class="prose" style="margin-top:8px;">${renderMd(r.body)}</div>
          </div>
        </div>
      `;
    }

    async function load(){
      if(!id){ titleEl.textContent='Topic not found'; return; }

      if(!isConfigured()){
        metaEl.innerHTML = `Supabase is not configured. Edit <span class="kbd">assets/supabase-config.js</span>.`;
        return;
      }

      const t = await getForumThread(id);
      if(!t){ titleEl.textContent='Topic not found'; metaEl.textContent=''; bodyEl.textContent=''; return; }

      titleEl.textContent = t.title;
      const who = t?.profiles?.display_name || 'Member';
      const when = new Date(t.created_at).toLocaleString();
      const catTitle = t?.forum_categories?.title || 'Category';
      metaEl.innerHTML = `${esc(catTitle)} â€¢ ${esc(who)} â€¢ ${esc(when)}${canReport ? ` â€¢ <button class="link-btn" type="button" data-report-ref="${makeContentRef('thread', t.id)}">Report</button>` : ``}`;

      if (t?.forum_categories?.slug) {
        backToCat.href = `forum-category.html?slug=${encodeURIComponent(t.forum_categories.slug)}`;
      }

      bodyEl.innerHTML = renderMd(t.body_md);

      const replies = await listForumReplies(id);
      repliesEl.innerHTML = replies.length ? replies.map(replyRow).join('') : `<div class="muted small">No replies yet.</div>`;

      // Reply gating
      const user = await getUser().catch(()=>null);
      const prof = user ? await getMyProfile().catch(()=>null) : null;
      canReport = Boolean(prof && prof.status === "active");

      if(!prof){
        replyHint.innerHTML = `Please <a href="account.html">sign in</a> to reply.`;
        replyBody.disabled = true;
        replySend.disabled = true;
      } else if(prof.status !== 'active') {
        replyHint.textContent = 'Your account is pending approval.';
        replyBody.disabled = true;
        replySend.disabled = true;
      } else {
        replyHint.textContent = 'Your reply will appear after approval.';
        replyBody.disabled = false;
        replySend.disabled = false;
      }
    }

    replySend?.addEventListener('click', async ()=>{
      try{
        const txt = (replyBody.value||'').trim();
        if(txt.length < 3) return;
        replySend.disabled = true;
        await submitForumReply({ thread_id: id, body: txt });
        replyBody.value='';
        replyHint.textContent = 'Sent for review. Thanks!';
      }catch(e){
        alert(e?.message || 'Could not send');
      }finally{
        replySend.disabled = false;
      }
    });

    load();

    document.addEventListener("click", async (e)=>{
      const btn = e.target?.closest?.("[data-report-ref]");
      if(!btn) return;
      e.preventDefault();
      try{
        if(!canReport) return alert("You need an approved account to report content.");
        const ref = btn.getAttribute("data-report-ref");
        const p = await openReportModal({ title: "Report", targetLabel: "this item" });
        if(!p) return;
        await submitReport(ref, p.reason, p.details);
        alert("Report submitted. Thanks â€” we will review it.");
      }catch(err){
        alert(err?.message || "Could not submit report");
      }
    });
  </script>
</body>
</html>
