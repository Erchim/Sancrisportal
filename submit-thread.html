<!doctype html>
<html lang="en">
<head>
  <title>Submit topic â€” Events San Cristobal</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0b0c10" />
  <link rel="stylesheet" href="assets/style.css?v=24.0" />
  <meta name="description" content="Submit a forum topic." />
</head>
<body>
  <header class="site-header">
    <div class="wrap header-inner">
      <a class="brand" href="index.html" aria-label="Home">
        <span class="brand-title" data-site-title>Events San Cristobal</span>
        <span class="brand-sub" data-site-sub>Local portal for San CristÃ³bal de las Casas: events, life guides, nature trips, hotels, food, and practical FAQ.</span>
      </a>
      <div class="header-actions">
        <button class="icon-btn" id="searchBtn" aria-label="Search" aria-expanded="false" aria-controls="searchPanel">ðŸ”Ž</button>
        <button class="icon-btn" id="menuBtn" aria-label="Menu" aria-expanded="false" aria-controls="siteNav">â˜°</button>
      </div>
    </div>
    <div class="wrap">
      <div class="search-panel" id="searchPanel" hidden>
        <form class="search-form" action="search.html" method="get">
          <input class="search-input" id="headerSearchInput" type="search" name="q" placeholder="Search the portalâ€¦" autocomplete="off" />
          <button class="btn" type="submit">Search</button>
        </form>
        <div class="suggestions" id="headerSuggestions" hidden></div>
      </div>

      <nav class="nav" id="siteNav" hidden>
        <a href="index.html">Home</a>
        <a href="articles.html">Life</a>
        <a href="nature.html">Nature</a>
        <a href="events.html">Events</a>
        <a href="hotels.html">Hotels</a>
        <a href="restaurants.html">Food</a>
        <a href="music.html">Music</a>
        <a href="faq.html">FAQ</a>
        <a href="community.html">Community</a>
        <a href="forum.html">Forum</a>
        <a href="businesses.html">Businesses</a>
        <a href="submit.html">Submit</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section class="hero hero-simple">
      <h1 class="h1">Submit a topic</h1>
      <p class="lead">Only approved users can submit. Your topic will appear after moderation.</p>
      <div class="hero-actions">
        <a class="btn ghost" href="forum.html">Back to Forum</a>
        <a class="btn" href="account.html">Account</a>
      </div>
    </section>

    <section class="section">
      <div id="gate" class="card" style="padding:16px;"></div>

      <div class="card" style="padding:16px; margin-top:14px;">
        <form id="topicForm" class="form-grid">
          <label class="field">
            <span class="field-label">Category</span>
            <select id="cat" class="input"></select>
          </label>

          <label class="field">
            <span class="field-label">Title</span>
            <input id="title" class="input" maxlength="120" placeholder="E.g., Best coffee in town?" required />
          </label>

          <label class="field" style="grid-column:1/-1;">
            <span class="field-label">Message (Markdown supported)</span>
            <textarea id="body" class="input" rows="10" placeholder="Write your postâ€¦" required></textarea>
          </label>

          <div class="filters" style="grid-column:1/-1; gap:10px;">
            <button class="btn" type="submit">Send for review</button>
            <span class="muted small" id="status"></span>
          </div>
        </form>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="wrap footer-inner">
      <div>Â© <span id="year"></span> <span data-site-title>Portal</span></div>
      <div class="muted">Built for travelers & locals</div>
    </div>
  </footer>

  <script src="assets/app.js?v=24.0"></script>
  <script type="module" src="assets/auth-nav.mjs?v=24.0"></script>
  <script type="module">
    import { isConfigured, getMyProfile, listForumCategories, submitForumThread, getForumCategoryBySlug } from "./assets/community.mjs?v=24.0";

    const gate = document.getElementById('gate');
    const form = document.getElementById('topicForm');
    const catSel = document.getElementById('cat');
    const title = document.getElementById('title');
    const body = document.getElementById('body');
    const status = document.getElementById('status');

    const params = new URLSearchParams(location.search);
    const preSlug = params.get('slug');

    function esc(s){return String(s??'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));}

    async function init(){
      if(!isConfigured()){
        gate.innerHTML = `<div class="notice"><div class="notice-title">Not connected</div><div class="notice-body">Configure <span class="kbd">assets/supabase-config.js</span>, then reload.</div></div>`;
        form.style.display = 'none';
        return;
      }

      const prof = await getMyProfile().catch(()=>null);
      if(!prof){
        gate.innerHTML = `<div class="notice"><div class="notice-title">Sign in required</div><div class="notice-body">Please sign in first.</div></div>`;
        form.style.display = 'none';
        return;
      }
      if(prof.status !== 'active'){
        gate.innerHTML = `<div class="notice"><div class="notice-title">Pending approval</div><div class="notice-body">We review registrations 1â€“3 days. After approval you can post.</div></div>`;
        form.style.display = 'none';
        return;
      }

      gate.innerHTML = `<div class="notice"><div class="notice-title">Ready</div><div class="notice-body">Be kind. No spam. Your post will appear after moderation.</div></div>`;

      const cats = await listForumCategories();
      catSel.innerHTML = cats.map(c=>`<option value="${esc(c.id)}">${esc(c.title)}</option>`).join('');

      if(preSlug){
        const c = await getForumCategoryBySlug(preSlug).catch(()=>null);
        if(c){ catSel.value = c.id; }
      }

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        status.textContent = 'Sendingâ€¦';
        try{
          const category_id = catSel.value;
          const t = title.value.trim();
          const b = body.value.trim();
          if(!t || !b){ status.textContent = 'Please fill all fields.'; return; }
          await submitForumThread({ category_id, title: t, body_md: b });
          status.textContent = 'Sent for review âœ…';
          setTimeout(()=>{ location.href = 'forum.html'; }, 900);
        }catch(err){
          status.textContent = err?.message || 'Failed.';
        }
      });
    }

    init();
  </script>
</body>
</html>
